<?
function customer_tracking_statistics(){
error_reporting(E_ALL);
ini_set('display_errors', 1);

	$date_from_str = date('d-m-Y');
	if(isset($_REQUEST['date_from'])){
		$date_from_str = $_REQUEST['date_from'];
	}
	$date_from_arr = explode("-",$date_from_str);
	$date_from = $date_from_arr[2]."-".$date_from_arr[1]."-".$date_from_arr[0];
	$date_to_str = date('d-m-Y');
	if(isset($_REQUEST['date_to'])){
		$date_to_str = $_REQUEST['date_to'];
	}
	$date_to_real =  date('d-m-Y',strtotime($date_to_str." +1 days"));
	$date_to_arr = explode("-",$date_to_real);
	$date_to = $date_to_arr[2]."-".$date_to_arr[1]."-".$date_to_arr[0];
	
	$dates_sql = " tracking_date >= '".$date_from."' AND tracking_date < '".$date_to."' ";
	$filter_campaign_1 = false;
	$filter_campaign_2 = false;

	$filter_campaign_1_checked = "";
	$filter_campaign_2_checked = "";

	if(isset($_REQUEST['campaign']['1'])){
		$filter_campaign_1 = true;
		$filter_campaign_1_checked = "checked";		
	}
	if(isset($_REQUEST['campaign']['2'])){
		$filter_campaign_2 = true;
		$filter_campaign_2_checked = "checked";		
	}
	$campaign_sql = "";
	if($filter_campaign_1 && $filter_campaign_2){
		$campaign_sql = " AND (has_gclid = '1' OR has_gclid = '2')";
	}
	else{
		if($filter_campaign_1){
			$campaign_sql = " AND has_gclid = '1' ";
		}
		if($filter_campaign_2){
			$campaign_sql = " AND has_gclid = '2' ";
		}
	}
	$browser_type = "all";
	$browser_types = array("all"=>array('str'=>'הכל','checked'=>''),"1"=>array('str'=>'מובייל','checked'=>''),"0"=>array('str'=>'מחשב','checked'=>''));
	if(isset($_REQUEST['browser_type'])){
		$browser_type = $_REQUEST['browser_type'];
		
	}
	$browser_types[$browser_type]['checked'] = "selected";
	$group_by = 'cat_f';
	if(isset($_REQUEST['group_by'])){
		$group_by = $_REQUEST['group_by'];
	}
	$group_by_str = $group_by."_str";
	$sql_group_by = $group_by;
	if($group_by == 'page_data'){
		$group_by_str = "page_str";
		$sql_group_by = " page_id,page_m,page_type,site_id ";
	}
	if($group_by == 'site_id'){
		$group_by_str = "site_str";
	}	
	$group_by_options = array(
		'cat_f'=>array("str"=>'קטגוריה ראשית','parent'=>'0'),
		'cat_s'=>array("str"=>'קטגוריה משנית','parent'=>'cat_f'),
		'cat_spec'=>array("str"=>'תחום','parent'=>'cat_s'),
		'tracking_date'=>array("str"=>'יום','parent'=>'0'),
		'tracking_hour'=>array("str"=>'שעה','parent'=>'tracking_date'),
		'site_id'=>array("str"=>'דומיין','parent'=>'0'),
		'page_data'=>array("str"=>'דף','parent'=>'0'),
	); 
	foreach($group_by_options as $key=>$option){
		if($group_by == $key){
			$group_by_options[$key]['selected'] = 'selected';
		}
		else{
			$group_by_options[$key]['selected'] = ''; 
		}
	} 
	$group_by_col_name = $group_by_options[$group_by]['str'];
	if($group_by == "page_data"){
		$group_by_col_name = "עמוד";
	}
	if($group_by == "site_id"){
		$group_by_col_name = "אתר";
	}	
	$select_sql = "";
	$table_fields = array();
	if(!isset($_REQUEST['cat_f'])){
		$select_sql .= " ,SUM(f_uniq) as sum_f_uniq ";
		$table_fields[] = array("select_as"=>"sum_f_uniq","str"=>"צפיות ייחודיות לקטגוריה","sum"=>'1');
		$table_fields[] = array("select_as"=>"presentage_f_uniq","str"=>"%","sum"=>'0','color'=>'#ece6e6');
	}
	if(!isset($_REQUEST['cat_s'])){
		$select_sql .= " ,SUM(s_uniq) as sum_s_uniq ";
		$table_fields[] = array("select_as"=>"sum_s_uniq","str"=>"צפיות ייחודיות לתת קטגוריה","sum"=>'1');
		$table_fields[] = array("select_as"=>"presentage_s_uniq","str"=>"%","sum"=>'0','color'=>'#ece6e6');
	}
	if(!isset($_REQUEST['cat_spec'])){
		$select_sql .= " ,SUM(spec_uniq) as sum_spec_uniq ";
		$table_fields[] = array("select_as"=>"sum_spec_uniq","str"=>"צפיות ייחודיות לתחום","sum"=>'1');
		$table_fields[] = array("select_as"=>"presentage_spec_uniq","str"=>"%","sum"=>'0','color'=>'#ece6e6');
	}
	if(!isset($_REQUEST['page_data'])){
		$select_sql .= " ,SUM(page_uniq) as sum_page_uniq ";
		$table_fields[] = array("select_as"=>"sum_page_uniq","str"=>"צפיות ייחודיות לעמוד","sum"=>'1');
		$table_fields[] = array("select_as"=>"presentage_page_uniq","str"=>"%","sum"=>'0','color'=>'#ece6e6');
	}
	$select_sql .= " ,SUM(form_submited) as sum_form_submited ";
	$table_fields[] = array("select_as"=>"sum_form_submited","str"=>"לידים מתוך הצפיות","sum"=>'1');
	
	//$table_fields[] = array("select_as"=>"sum_form_submited_by_forms","str"=>"לידים על פי טפסים");
	$select_sql .= " ,SUM(customer_send) as sum_customer_send ";
	$table_fields[] = array("select_as"=>"sum_customer_send","str"=>"שליחה ללקוחות","sum"=>'1');
	$where_sql = $dates_sql.$campaign_sql;
	$cat_names = array();
	if(isset($_REQUEST['cat_f'])){
		$where_sql .= " AND cat_f = '".$_REQUEST['cat_f']."' ";
		$cat_names[$_REQUEST['cat_f']] = get_cat_name_from_db($_REQUEST['cat_f']);
	}
	if(isset($_REQUEST['cat_s'])){
		$where_sql .= " AND cat_s = '".$_REQUEST['cat_s']."' ";
		$cat_names[$_REQUEST['cat_s']] = get_cat_name_from_db($_REQUEST['cat_s']);		
	}
	if(isset($_REQUEST['cat_spec'])){
		$where_sql .= " AND cat_spec = '".$_REQUEST['cat_spec']."' ";
		$cat_names[$_REQUEST['cat_spec']] = get_cat_name_from_db($_REQUEST['cat_spec']);		
	}
	$page_data = array();
	if(isset($_REQUEST['page_data'])){
		$page_data_arr = explode("_",$_REQUEST['page_data']);
		$page_id = $page_data_arr[0];
		$page_m = $page_data_arr[1];
		$page_type = $page_data_arr[2];
		$site_id = $page_data_arr[3];
		$where_sql .= " AND page_id = '".$page_id."'  AND page_m = '".$page_m."'  AND page_type = '".$page_type."' AND site_id = '".$site_id."' ";
		$page_data = get_page_data_from_db($page_id,$page_m,$page_type,$site_id);
	}
	$site_data = array();
	if(isset($_REQUEST['site_id'])){
		$where_sql .= " AND site_id = '".$_REQUEST['site_id']."' ";
		$site_data = get_site_data_from_db($_REQUEST['site_id']);
	}
	if(isset($_REQUEST['tracking_date'])){
		$where_sql .= " AND tracking_date = '".$_REQUEST['tracking_date']."' ";
	}
	if(isset($_REQUEST['tracking_hour'])){
		$where_sql .= " AND tracking_hour = '".$_REQUEST['tracking_hour']."' ";
	}
	if(isset($_REQUEST['browser_type'])){
		if($_REQUEST['browser_type'] != "all"){
			$where_sql .= " AND is_mobile = '".$_REQUEST['browser_type']."' ";
		}  
	}	
	if($group_by == 'cat_f' || $group_by == 'cat_s' || $group_by == 'cat_spec'){  
		$form_counts = get_form_counts($group_by,$date_from,$date_to,$filter_campaign_1,$filter_campaign_2);
	}
	$main_sql = "SELECT ".$sql_group_by." ".$select_sql." FROM customer_tracking WHERE ".$where_sql." GROUP BY ".$sql_group_by." ";
	$main_res = mysql_db_query(DB,$main_sql);
	$statistics_result = array();
	$sum_row = array();
	while($data_row = mysql_fetch_array($main_res)){
		if($group_by == 'cat_f' || $group_by == 'cat_s' || $group_by == 'cat_spec'){
			$data_row[$group_by_str] = get_cat_name_from_db($data_row[$group_by])."[".$data_row[$group_by]."]"; 
		}
		elseif($group_by == 'page_data'){
			$row_page_data = get_page_data_from_db($data_row['page_id'],$data_row['page_m'],$data_row['page_type'],$data_row['site_id']);
			$data_row[$group_by_str] = $row_page_data['site_name']." - ".$row_page_data['type_txt']."<br/>".$row_page_data['page_name']."[".$data_row['page_id']."]";
			$data_row[$group_by] = $data_row['page_id']."_".$data_row['page_m']."_".$data_row['page_type']."_".$data_row['site_id'];
		}
		
		elseif($group_by == 'site_id'){
			$row_site_data = get_site_data_from_db($data_row[$group_by]);
			$data_row[$group_by_str] = $row_site_data['name']."<br/>".$row_site_data['domain'];
		}
		else{
			$data_row[$group_by_str] = $data_row[$group_by];
		}
		if(isset($data_row["sum_f_uniq"])){
			if($data_row["sum_form_submited"] == '0'){
				$data_row["presentage_f_uniq"] = '0';
			}
			else{
				$data_row["presentage_f_uniq"] = round((int)$data_row["sum_form_submited"]*100/(int)$data_row["sum_f_uniq"],2)."%";
			}
		}
		if(isset($data_row["sum_s_uniq"])){
			if($data_row["sum_form_submited"] == '0'){
				$data_row["presentage_s_uniq"] = '0';
			}
			else{
				$data_row["presentage_s_uniq"] = round((int)$data_row["sum_form_submited"]*100/(int)$data_row["sum_s_uniq"],2)."%";
			}
		}
		if(isset($data_row["sum_spec_uniq"])){
			if($data_row["sum_form_submited"] == '0'){
				$data_row["presentage_spec_uniq"] = '0';
			}
			else{
				$data_row["presentage_spec_uniq"] = round((int)$data_row["sum_form_submited"]*100/(int)$data_row["sum_spec_uniq"],2)."%";
			}
		}	
		if(isset($data_row["sum_page_uniq"])){
			if($data_row["sum_form_submited"] == '0'){
				$data_row["presentage_page_uniq"] = '0';
			}
			else{
				$data_row["presentage_page_uniq"] = round((int)$data_row["sum_form_submited"]*100/(int)$data_row["sum_page_uniq"],2)."%";
			}
		}
		
		foreach($table_fields as $table_field){
			if(isset($data_row[$table_field['select_as']])){
				if($table_field['sum'] == '1'){
					if(!isset($sum_row[$table_field['select_as']])){
						$sum_row[$table_field['select_as']] = 0;
					}
				
					$sum_row[$table_field['select_as']] += $data_row[$table_field['select_as']]; 
				}
			}
		}
		$statistics_result[$data_row[$group_by]] = $data_row;
	}
	if(isset($sum_row["sum_f_uniq"])){
		if($sum_row["sum_form_submited"] == '0'){
			$sum_row["presentage_f_uniq"] = '0';
		}
		else{
			$sum_row["presentage_f_uniq"] = round((int)$sum_row["sum_form_submited"]*100/(int)$sum_row["sum_f_uniq"],2)."%";
		}
	}
	if(isset($sum_row["sum_s_uniq"])){
		if($sum_row["sum_form_submited"] == '0'){
			$sum_row["presentage_s_uniq"] = '0';
		}
		else{
			$sum_row["presentage_s_uniq"] = round((int)$sum_row["sum_form_submited"]*100/(int)$sum_row["sum_s_uniq"],2)."%";
		}
	}
	if(isset($sum_row["sum_spec_uniq"])){
		if($sum_row["sum_form_submited"] == '0'){
			$sum_row["presentage_spec_uniq"] = '0';
		}
		else{
			$sum_row["presentage_spec_uniq"] = round((int)$sum_row["sum_form_submited"]*100/(int)$sum_row["sum_spec_uniq"],2)."%";
		}
	}	
	if(isset($sum_row["sum_page_uniq"])){
		if($sum_row["sum_form_submited"] == '0'){
			$sum_row["presentage_page_uniq"] = '0';
		}
		else{
			$sum_row["presentage_page_uniq"] = round((int)$sum_row["sum_form_submited"]*100/(int)$sum_row["sum_page_uniq"],2)."%";
		}
	}	
	
	echo "<hr/><pre style='text-align:left; direction:ltr;white-space: normal; padding:20px;background:yellow;' >";
	//print_r($_POST);  
	echo "<hr/>";
	echo $main_sql; 
	echo "</pre>";
	echo "<hr/>";
	
	?>
	<h2>סטטיסטיקה של אתרי השוואות מחיר</h2>
	<div><a href="index.php?sesid=<?php echo SESID; ?>">חזרה לתפריט הראשי</a></div>
	<div id="filter_wrap" style="padding: 15px;border: 1px solid black;background: #e6d7d7;margin: 15px 0px;">
		<h3>סינון תוצאות</h3>
		<form method="POST" action="" id="statistics_filter_form">
			<input type="hidden" name="filter_statistics" value="1" />
			<div id="campaign_filter" style="margin-left: 20px;float:right;background: #e5e5fb;padding: 10px;border: 1px solid blue;"> 
				<b>הצג רק תוצאות שבאו מקמפיין:</b>
				<input type="hidden" name="campaign[helper]" value="1" />
				<div class="campaign-filter-check">
					<input type="checkbox" name="campaign[1]" value="1" <?php echo $filter_campaign_1_checked; ?> />
					גוגל
					&nbsp;&nbsp;
					<input type="checkbox" name="campaign[2]" value="1" <?php echo $filter_campaign_2_checked; ?> />
					פייסבוק
				</div>				
			</div>
			<div id="mobile_filter" style="margin-left: 20px;float:right;background: #e5e5fb;padding: 10px;border: 1px solid blue;"> 
				<b>סוג מכשיר:</b>
				
				<div class="mobile-filter-select">
					<select name='browser_type' class='input_style' style='width: 120px;'>
						<?php foreach($browser_types as $key=>$type): ?>
							<option value='<?php echo $key; ?>' <?php echo $type['checked']; ?>><?php echo $type['str']; ?></option>
						<?php endforeach; ?>
					</select>	
				</div>				
			</div>			
			<div id="dates_filter" style="margin-left: 20px;float:right;background: #e5e5fb;padding: 10px;border: 1px solid blue;">
				<b>מתאריך</b>
				<br/>
				<input type="text" name="date_from" value="<?php echo $date_from_str; ?>" />				
			</div>
			<div id="dates_filter" style="margin-left: 20px;float:right;background: #e5e5fb;padding: 10px;border: 1px solid blue;">
				<b>עד תאריך</b>
				<br/>
				<input type="text" name="date_to" value="<?php echo $date_to_str; ?>" />				
			</div>			
			<?php if(isset($_REQUEST['cat_f'])): ?>
				<input type="hidden" id="cat_f_input" name="cat_f" value="<?php echo $_REQUEST['cat_f']; ?>" />
			<?php endif; ?>
			<?php if(isset($_REQUEST['cat_s'])): ?>
				<input type="hidden" id="cat_s_input" name="cat_s" value="<?php echo $_REQUEST['cat_s']; ?>" />
			<?php endif; ?>
			<?php if(isset($_REQUEST['cat_spec'])): ?>
				<input type="hidden" id="cat_spec_input" name="cat_spec" value="<?php echo $_REQUEST['cat_spec']; ?>" />
			<?php endif; ?>
			<?php if(isset($_REQUEST['page_data'])): ?>
				<input type="hidden" id="page_data_input" name="page_data" value="<?php echo $_REQUEST['page_data']; ?>" />
			<?php endif; ?>
			<?php if(isset($_REQUEST['site_id'])): ?>
				<input type="hidden" id="site_id_input" name="site_id" value="<?php echo $_REQUEST['site_id']; ?>" />
			<?php endif; ?>
			<?php if(isset($_REQUEST['tracking_date'])): ?>
				<input type="hidden" id="tracking_date_input" name="tracking_date" value="<?php echo $_REQUEST['tracking_date']; ?>" />
			<?php endif; ?>
			<?php if(isset($_REQUEST['tracking_hour'])): ?>
				<input type="hidden" id="tracking_hour_input" name="tracking_hour" value="<?php echo $_REQUEST['tracking_hour']; ?>" />
			<?php endif; ?>
			<?php if(isset($_REQUEST['is_mobile'])): ?>
				<input type="hidden" id="is_mobile_input" name="is_mobile" value="<?php echo $_REQUEST['is_mobile']; ?>" />
			<?php endif; ?>
			<input type="submit" value="הצג סטטיסטיקה" />
			<div style="clear:both;"></div>
			<hr/>
			<div>
				<?php if(isset($_REQUEST['cat_f'])): ?>
					<div class="request_filter" style="margin-left: 20px;float:right;background: #e5e5fb;padding: 10px;border: 1px solid blue;"> 
						<a style="display:block;float:left;color:red;border: 1px solid red;font-family: sans-serif;cursor: pointer;font-size: 11px;margin-right: 15px;font-weight: bold;" onclick="remove_param_from_stats_and_go('cat_f');">בטל בחירה</a>
						<b>קטגוריה:</b><br/>
						<?php echo $cat_names[$_REQUEST['cat_f']]; ?>
					</div>
				<?php endif; ?>
				<?php if(isset($_REQUEST['cat_s'])): ?>
					<div class="request_filter" style="margin-left: 20px;float:right;background: #e5e5fb;padding: 10px;border: 1px solid blue;"> 
						<a style="display:block;float:left;color:red;border: 1px solid red;font-family: sans-serif;cursor: pointer;font-size: 11px;margin-right: 15px;font-weight: bold;" onclick="remove_param_from_stats_and_go('cat_s');">בטל בחירה</a>
						<b>תת קטגוריה:</b><br/>
						<?php echo $cat_names[$_REQUEST['cat_s']]; ?>
					</div>
				<?php endif; ?>
				<?php if(isset($_REQUEST['cat_spec'])): ?>
					<div class="request_filter" style="margin-left: 20px;float:right;background: #e5e5fb;padding: 10px;border: 1px solid blue;"> 
						<a style="display:block;float:left;color:red;border: 1px solid red;font-family: sans-serif;cursor: pointer;font-size: 11px;margin-right: 15px;font-weight: bold;" onclick="remove_param_from_stats_and_go('cat_spec');">בטל בחירה</a>
						<b>תחום:</b><br/>
						<?php echo $cat_names[$_REQUEST['cat_spec']]; ?>
					</div>
				<?php endif; ?>
				<?php if(isset($_REQUEST['page_data'])): ?>
					<div class="request_filter" style="margin-left: 20px;float:right;background: #e5e5fb;padding: 10px;border: 1px solid blue;"> 
						<a style="display:block;float:left;color:red;border: 1px solid red;font-family: sans-serif;cursor: pointer;font-size: 11px;margin-right: 15px;font-weight: bold;" onclick="remove_param_from_stats_and_go('page_data');">בטל בחירה</a>
						<b>עמוד:</b><br/>
						<?php echo $page_data['type_txt']."<br/>".$page_data['page_name']; ?>
					</div>
				<?php endif; ?>
				<?php if(isset($_REQUEST['site_id'])): ?>
					<div class="request_filter" style="margin-left: 20px;float:right;background: #e5e5fb;padding: 10px;border: 1px solid blue;"> 
						<a style="display:block;float:left;color:red;border: 1px solid red;font-family: sans-serif;c